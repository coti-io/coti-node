package unitTest;

import io.coti.basenode.communication.JacksonSerializer;
import io.coti.basenode.data.TransactionData;
import io.coti.dspnode.AppConfig;
import io.coti.dspnode.services.TransactionService;
import org.junit.Assert;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.test.context.ContextConfiguration;
import org.springframework.test.context.TestPropertySource;
import org.springframework.test.context.junit4.SpringRunner;

@TestPropertySource(locations = "../test.properties")
@RunWith(SpringRunner.class)
@ContextConfiguration(classes = AppConfig.class)
@SpringBootTest
public class TransactionServiceTest {
    @Autowired
    private TransactionService transactionService;
    @Autowired
    private JacksonSerializer serializer;

    @Test
    public void handleNewTransactionFromFullNode_validSignature() {
        String jsonTransdaction =
                "{\"@class\":\"io.coti.basenode.data.TransactionData\",\"baseTransactions\":[{\"hash\":{\"bytes\":\"ycxWfoL9aB1T1FbHtHREkAdjoi46TqENte4H3zmEKpc=\",\"null\":false},\"addressHash\":{\"bytes\":\"dEloVF5RDzslgGJ8Bqre9V6x8ggyPmJqZjwbKVd12Rdkhqg/0Fl4s6dmrsqjBfDlck7EKu1hZk80fMO5VUJ4pfAJfzY=\",\"null\":false},\"amount\":-6.263729263473981,\"createTime\":1536130939765,\"signatureData\":{\"r\":\"f0f0426ef357f762bd4dd01a1f54d8bac0baeb3264ae742cc10cd967e6cc7112\",\"s\":\"236764826d99fb5a269ea93665af36ef30382789b2456d03f92b09d66c817608\"},\"signatureExists\":true},{\"hash\":{\"bytes\":\"RSOBFAB+SjMMtKPiyIV4g79kCK/H7HMTasilS4Aggu4=\",\"null\":false},\"addressHash\":{\"bytes\":\"DsX6UD1iA7W5Bz0vdnavV+fyZuCkshicHLSjiIE1TlDexBKcnPPUcV0RuwXl7kF+ZjFTbtLwTV1gh0TIcwA78RyzSJ8=\",\"null\":false},\"amount\":-4.430306556802998,\"createTime\":1536130939766,\"signatureData\":{\"r\":\"1f7b7613f4db49678e0317dac6df13f25bd039bf8717e38017168da8193c46eb\",\"s\":\"286a49a3afd7cf81bdd1be1826127741bbebfba36089b5e6608dad84612c091a\"},\"signatureExists\":true},{\"hash\":{\"bytes\":\"F0euFxr9FlZtQVdWNqAylXYA463cuzmsbA1bs4aZu8A=\",\"null\":false},\"addressHash\":{\"bytes\":\"cOd4u9PfpC1ZFzen4ZkMo54dCN5qOh24md3c8gJvqGs7RsTW32Fp6GiYEGeiMGvq4kulgkgo75j+whRSYVZgPkDrdFE=\",\"null\":false},\"amount\":-5.532748116929812,\"createTime\":1536130939766,\"signatureData\":{\"r\":\"cef24dffd965d3fb2558ac791b0fdc81293c6c049637a4e97e8e775c4c27908b\",\"s\":\"b4d7a719f70d95c3d8af6a2c859a1450a29d464318ee3ea4ecc8cdd2bd752581\"},\"signatureExists\":true},{\"hash\":{\"bytes\":\"YGT2Ek5gG4GBqVpRW7UjiIwdzp8rhpCtskfeP+rZ5XU=\",\"null\":false},\"addressHash\":{\"bytes\":\"Eep/zBed+rL0gIkPe3j4ddchJqg8kPPzLu/bqGxvtAVHpvJXBauJCzuPxs1FkXCUYiGyBAUvCEq9A9qVTLLONlZCtAw=\",\"null\":false},\"amount\":16.226783937206791,\"createTime\":1536130939766,\"signatureData\":null,\"signatureExists\":false}],\"hash\":{\"bytes\":\"9tfHEH4rg2aB30sCBc8uZwLYKHOlAVZFR0L3hIHF87I=\",\"null\":false},\"amount\":16.226783937206791,\"leftParentHash\":{\"bytes\":\"AAAABg==\",\"null\":false},\"rightParentHash\":{\"bytes\":\"AAAABQ==\",\"null\":false},\"trustChainTransactionHashes\":[],\"userTrustScoreTokenHashes\":null,\"trustChainConsensus\":false,\"trustChainTrustScore\":0.0,\"transactionConsensusUpdateTime\":null,\"createTime\":1536130939764,\"attachmentTime\":1536130946530,\"processStartTime\":1536130941295,\"powStartTime\":1536130941529,\"powEndTime\":1536130946530,\"senderTrustScore\":58.97914,\"senderHash\":{\"bytes\":\"BGIdqosPY3CIfLyjz0XBHE957jhc3y703F3mk4qRBaqxk9ZwJULimnpgI7LnrVfKxanqXVSZEhy1kai50JJ2SSM=\",\"null\":false},\"nodeIpAddress\":null,\"nodeHash\":{\"bytes\":\"YQcoNdZ+hV9g7dweW1gmrfmv41IdZQcZzhLjeqXnpF/T7WV5bmpFT48Rc+2RHrop8TSib/O81xhChFErqw7RmA==\",\"null\":false},\"nodeSignature\":{\"r\":\"7eba239eb266fc2df47ee5f4861b2dbfbeea6ca3acc81b5a3ccb35ba9ae8f146\",\"s\":\"60dd9f52caa2d77f09ab6cdad2dfc5510bca8baad948eaed72b137334665d1d3\"},\"childrenTransactions\":[],\"valid\":null,\"validByNodes\":null,\"transactionDescription\":\"test\",\"dspConsensusResult\":null,\"trustScoreResults\":[{\"userHash\":{\"bytes\":\"BGIdqosPY3CIfLyjz0XBHE957jhc3y703F3mk4qRBaqxk9ZwJULimnpgI7LnrVfKxanqXVSZEhy1kai50JJ2SSM=\",\"null\":false},\"transactionHash\":{\"bytes\":\"9tfHEH4rg2aB30sCBc8uZwLYKHOlAVZFR0L3hIHF87I=\",\"null\":false},\"trustScore\":58.97914,\"trustScoreNodeHash\":{\"bytes\":\"u4QC9rDwHTH/tEeZrjPYaFcrvTSeF+LJGH4Iq+ZNHmXNSzWib58iliny5ggqvq27aQ0RR9sdUoV9rLiNwxPziQ==\",\"null\":false},\"trustScoreNodeSignature\":{\"r\":\"7a0bd8e3bab500f33245372b1de5b9eb700c9bc3b0fb95bef38a4bba87d5330e\",\"s\":\"a20c37c31439e02faaf266482bb020a8a03541defd6c4f01c40695b96ea98e04\"},\"signature\":{\"r\":\"7a0bd8e3bab500f33245372b1de5b9eb700c9bc3b0fb95bef38a4bba87d5330e\",\"s\":\"a20c37c31439e02faaf266482bb020a8a03541defd6c4f01c40695b96ea98e04\"},\"signerHash\":{\"bytes\":\"u4QC9rDwHTH/tEeZrjPYaFcrvTSeF+LJGH4Iq+ZNHmXNSzWib58iliny5ggqvq27aQ0RR9sdUoV9rLiNwxPziQ==\",\"null\":false}}],\"signature\":{\"r\":\"7eba239eb266fc2df47ee5f4861b2dbfbeea6ca3acc81b5a3ccb35ba9ae8f146\",\"s\":\"60dd9f52caa2d77f09ab6cdad2dfc5510bca8baad948eaed72b137334665d1d3\"},\"signerHash\":{\"bytes\":\"YQcoNdZ+hV9g7dweW1gmrfmv41IdZQcZzhLjeqXnpF/T7WV5bmpFT48Rc+2RHrop8TSib/O81xhChFErqw7RmA==\",\"null\":false},\"zeroSpend\":false,\"source\":true,\"visit\":false,\"roundedSenderTrustScore\":59}";
        byte[] transactionBytes = jsonTransdaction.getBytes();
        TransactionData transactionData = serializer.deserialize(transactionBytes);
        String result = transactionService.handleNewTransactionFromFullNode(transactionData);
        Assert.assertTrue(new String("Received Transaction: " + transactionData.getHash().toString()).equals(result));
    }

    @Test
    public void handleNewTransactionFromFullNode_notValidSignature() {
        String jsonTransdaction =
                "{\"@class\":\"io.coti.basenode.data.TransactionData\",\"baseTransactions\":[{\"hash\":{\"bytes\":\"J3NE93DHTo0txYdXjIWXNI4g38FmwTENYMMM4Z7POYc=\",\"null\":false},\"addressHash\":{\"bytes\":\"3NIYnuu5QIADjNbUqW0qmw6EGD8eGLP4mH7zqAoc3R+WjwpoE2dzy6EZBhZFKlCMkMoC4QhE/I8wcfuBVuIM8WUXT00=\",\"null\":false},\"amount\":-3.1753714423012624,\"createTime\":1536072105444,\"signatureData\":{\"r\":\"21f16ff751e4a2b65f49be2e811bc987633eb95fb369575a87a8e27606a9d203\",\"s\":\"bd4e31761d24d8f53d28b146522626255a3e4f6716f12f0714913a94b4bf9ab7\"},\"signatureExists\":true},{\"hash\":{\"bytes\":\"c4F1QNsF6VeaQujXjfJhvNA3E2OZpA/gNF/rm+yJGNk=\",\"null\":false},\"addressHash\":{\"bytes\":\"AxpsUWhVEbbdRo1nBgCvqejNqIkVvp1+hEnJBVRcHxQbngK793Rp9HiKhIGlP7XSotIZIHFVVcGEXDFaMN4C7jR2L2I=\",\"null\":false},\"amount\":-7.989979776935282,\"createTime\":1536072105444,\"signatureData\":{\"r\":\"31e0ddcda58d7386cc8deaad16bf51a1bd54837521811d1698674751d1d81786\",\"s\":\"fb9c2050ae7a1202c570c55ac79b17c1a33067e2ba49cfb34222b25698fc0251\"},\"signatureExists\":true},{\"hash\":{\"bytes\":\"eo7nlAJk09bKx27FnwPTIDeZTkQW59AgU0wbNmXWulo=\",\"null\":false},\"addressHash\":{\"bytes\":\"z5X+m0H2gCr/5BdMdXvEme1TxikLH8mUn/Df9kDDIo9ReymgkvwHoNEcKYBvG95qJibfEjny71jYq/k7TznIbf6CRM0=\",\"null\":false},\"amount\":-8.715301137784074,\"createTime\":1536072105445,\"signatureData\":{\"r\":\"49b525d57d6312c0fd660d1dea297e45bdcb3e15dd153f8de6b0505d1687ea2c\",\"s\":\"97f299032e55b613bab33f610cd83a05bfb552abdd8597eaab7d5986c6c2d737\"},\"signatureExists\":true},{\"hash\":{\"bytes\":\"eUPc8tdKJ8DQI0kByyxGGj0vhqR/mbKpWbmtlMmf0OU=\",\"null\":false},\"addressHash\":{\"bytes\":\"HW5pjO5iV+hYy1DH/u79GvN9HfcxWPYidzzHGou9jtObpnirBenNL+1lwTZxE4a/m4Kc0arMX0LWdu8IXqgBrEQeoRM=\",\"null\":false},\"amount\":19.8806523570206184,\"createTime\":1536072105445,\"signatureData\":null,\"signatureExists\":false}],\"hash\":{\"bytes\":\"3MBlhOCO3N1al+Gn7FPjHSYlSeu+XRi/qZVS1uGibyw=\",\"null\":false},\"amount\":19.8806523570206184,\"leftParentHash\":{\"bytes\":\"AAAACA==\",\"null\":false},\"rightParentHash\":{\"bytes\":\"AAAACQ==\",\"null\":false},\"trustChainTransactionHashes\":[],\"userTrustScoreTokenHashes\":null,\"trustChainConsensus\":false,\"trustChainTrustScore\":0.0,\"transactionConsensusUpdateTime\":null,\"createTime\":1536072105442,\"attachmentTime\":1536072113440,\"processStartTime\":1536072108204,\"powStartTime\":1536072108439,\"powEndTime\":1536072113440,\"senderTrustScore\":81.61878,\"senderHash\":{\"bytes\":\"BIFOiq3gX+CpCGRLxaeP9x4wLsiAf5rSZoAkXF8WrnFj/9lhLQp1150mk8lbai+oJpCWejput+Fl1YgMFHA/Ug0=\",\"null\":false},\"nodeIpAddress\":null,\"nodeHash\":{\"bytes\":\"YQcoNdZ+hV9g7dweW1gmrfmv41IdZQcZzhLjeqXnpF/T7WV5bmpFT48Rc+2RHrop8TSib/O81xhChFErqw7RmA==\",\"null\":false},\"nodeSignature\":{\"r\":\"62c42f2376ae1832f4ac2fb437c948ca710c30c8798fac85c511b8faccb7be45\",\"s\":\"bb834a95f7c69d4c60ec563cdf5933398924380ea9c67c40168ea3e316754861\"},\"childrenTransactions\":[],\"valid\":null,\"validByNodes\":null,\"transactionDescription\":\"test\",\"dspConsensusResult\":null,\"trustScoreResults\":[{\"userHash\":{\"bytes\":\"BIFOiq3gX+CpCGRLxaeP9x4wLsiAf5rSZoAkXF8WrnFj/9lhLQp1150mk8lbai+oJpCWejput+Fl1YgMFHA/Ug0=\",\"null\":false},\"transactionHash\":{\"bytes\":\"3MBlhOCO3N1al+Gn7FPjHSYlSeu+XRi/qZVS1uGibyw=\",\"null\":false},\"trustScore\":81.61878,\"trustScoreNodeHash\":{\"bytes\":\"u4QC9rDwHTH/tEeZrjPYaFcrvTSeF+LJGH4Iq+ZNHmXNSzWib58iliny5ggqvq27aQ0RR9sdUoV9rLiNwxPziQ==\",\"null\":false},\"trustScoreNodeSignature\":{\"r\":\"c57b723bd50e883ff1d20aa9b74db3677e9fd402f10882c861ba0ef02603f185\",\"s\":\"b5ac5c9b07f8bfc25c38bd04d437e0bd0f4019bb70b296dc3a5d8cb0093133c8\"},\"signature\":{\"r\":\"c57b723bd50e883ff1d20aa9b74db3677e9fd402f10882c861ba0ef02603f185\",\"s\":\"b5ac5c9b07f8bfc25c38bd04d437e0bd0f4019bb70b296dc3a5d8cb0093133c8\"},\"signerHash\":{\"bytes\":\"u4QC9rDwHTH/tEeZrjPYaFcrvTSeF+LJGH4Iq+ZNHmXNSzWib58iliny5ggqvq27aQ0RR9sdUoV9rLiNwxPziQ==\",\"null\":false}}],\"signature\":{\"r\":\"62c42f2376ae1832f4ac2fb437c948ca710c30c8798fac85c511b8faccb7be45\",\"s\":\"bb834a95f7c69d4c60ec563cdf5933398924380ea9c67c40168ea3e316754861\"},\"roundedSenderTrustScore\":82,\"signerHash\":{\"bytes\":\"YQcoNdZ+hV9g7dweW1gmrfmv41IdZQcZzhLjeqXnpF/T7WV5bmpFT48Rc+2RHrop8TSib/O81xhChFErqw7RmA==\",\"null\":false},\"visit\":false,\"zeroSpend\":false,\"source\":true}\n";
        byte[] transactionBytes = jsonTransdaction.getBytes();
        TransactionData transactionData = serializer.deserialize(transactionBytes);
        String result = transactionService.handleNewTransactionFromFullNode(transactionData);
        Assert.assertFalse(new String("Received Transaction: " + transactionData.getHash().toString()).equals(result));
    }
}
